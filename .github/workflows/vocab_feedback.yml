name: AI Coach Feedback

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull_requests: write

jobs:
  review-homework:
    # Only run on comments in issues (not PRs) and avoid loops (bot comments)
    if: ${{ !github.event.issue.pull_request && github.event.comment.user.type != 'Bot' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Dependencies
        run: pip install requests

      - name: Run AI Review
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: "https://api.deepseek.com"
          LLM_MODEL: "deepseek-chat"
        run: |
          cd scripts
          python review_comment.py
          
      - name: Check and Post Feedback
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          if [ -f "scripts/feedback_body.md" ]; then
             gh issue comment "$ISSUE_NUMBER" --body-file "scripts/feedback_body.md"
          else
             echo "No feedback generated (or file not found)."
          fi
